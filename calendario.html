<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione KIT - Cloud & JSON Import</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #007bff; --kit: #2c3e50; --holiday: #dfdfdf; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background-color: var(--bg); }
        #toolbar-container { margin-bottom: 10px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .controls-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #eee; }
        #toolbar { padding: 15px; display: none; gap: 10px; justify-content: center; flex-wrap: wrap; }
        #calendar-outer-wrapper { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); min-height: 600px; }
        
        .fc-event-kit { background-color: var(--kit) !important; color: white !important; }
        .fc-event-holiday { background-color: var(--holiday) !important; color: #333 !important; font-weight: bold; pointer-events: none; }
        
        .sync-indicator { font-size: 0.85em; font-weight: bold; padding: 5px 12px; border-radius: 20px; }
        .sync-ok { background: #d4edda; color: #155724; }
        .sync-wait { background: #fff3cd; color: #856404; }
        
        button { padding: 8px 16px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: white; font-weight: 600; }
        .btn-import { background: #28a745; color: white; border: none; }
    </style>
</head>
<body>

    <div id="toolbar-container">
        <div class="controls-row">
            <button onclick="toggleToolbar()">‚öôÔ∏è Gestione <span id="arrow">‚ñº</span></button>
            <div id="sync-status" class="sync-indicator sync-wait">Connessione...</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="changeZoom(-0.1)">-</button>
                <span id="zoom-val">100%</span>
                <button onclick="changeZoom(0.1)">+</button>
            </div>
        </div>
        <div id="toolbar">
            <button class="btn-import" onclick="document.getElementById('jsonInput').click()">üìÇ Carica Progetto JSON</button>
            <input type="file" id="jsonInput" style="display:none" accept=".json" onchange="importJSON(event)">
            
            <button onclick="exportTableAsImage()">üì∏ Esporta PNG</button>
            <button onclick="clearFirebase()" style="color:red">üóëÔ∏è Svuota Cloud</button>
        </div>
    </div>

    <div id="calendar-outer-wrapper">
        <div id="calendar"></div>
    </div>

    <script>
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
apiKey: "AIzaSyCyKOYvV18rJ2E6wedKB4NSvu-gP_hMDPI",
  authDomain: "calendario-kit.firebaseapp.com",
  databaseURL: "https://calendario-kit-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendario-kit",
  storageBucket: "calendario-kit.firebasestorage.app",
  messagingSenderId: "912995766124",
  appId: "1:912995766124:web:2ee26f77adbe6da28bad49"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const eventsRef = db.ref('pico_events_2026');

        let calendar;
        const holidays2026 = [
            { title: "Capodanno", start: "2026-01-01", className: "fc-event-holiday" },
            { title: "Epifania", start: "2026-01-06", className: "fc-event-holiday" },
            { title: "Liberazione", start: "2026-04-25", className: "fc-event-holiday" },
            { title: "Natale", start: "2026-12-25", className: "fc-event-holiday" }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'it',
                firstDay: 1,
                height: 'auto',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'multiMonthYear,dayGridMonth' },
                events: holidays2026,
                selectable: true,
                editable: true,
                eventAdd: syncToFirebase,
                eventChange: syncToFirebase,
                eventRemove: syncToFirebase,
                select: function(info) {
                    let nome = prompt("Nome evento:");
                    if (nome) {
                        calendar.addEvent({
                            title: nome,
                            start: info.startStr,
                            allDay: true,
                            className: nome.toUpperCase() === "KIT" ? "fc-event-kit" : "fc-event-custom",
                            extendedProps: { note: prompt("Note:") || "" }
                        });
                    }
                    calendar.unselect();
                }
            });
            calendar.render();

            // Ascolta cambiamenti dal cloud
            eventsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                calendar.removeAllEvents();
                calendar.addEventSource(holidays2026);
                if (data) calendar.addEventSource(Object.values(data));
                setStatus("Sincronizzato ‚úîÔ∏è", "sync-ok");
            }, (error) => {
                console.error("Errore Firebase:", error);
                setStatus("Errore Permessi/Regole", "sync-wait");
            });
        });

        // --- FUNZIONE IMPORT JSON ---
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedEvents = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedEvents)) {
                        alert("Il file JSON non √® in un formato valido (deve essere una lista di eventi).");
                        return;
                    }

                    if (confirm(`Trovati ${importedEvents.length} eventi nel file. Vuoi aggiungerli al Cloud?`)) {
                        setStatus("Caricamento... ‚è≥", "sync-wait");
                        
                        // Prendiamo i dati attuali dal cloud per fare un merge
                        eventsRef.once('value', (snap) => {
                            const currentEvents = snap.val() ? Object.values(snap.val()) : [];
                            const combined = currentEvents.concat(importedEvents);
                            
                            // Aggiorniamo Firebase (questo attiver√† automaticamente il refresh del calendario)
                            eventsRef.set(combined).then(() => {
                                alert("Dati importati e sincronizzati con successo!");
                            });
                        });
                    }
                } catch (err) {
                    alert("Errore durante la lettura del file JSON: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function syncToFirebase() {
            setStatus("Salvataggio... ‚è≥", "sync-wait");
            const toSave = calendar.getEvents()
                .filter(e => !e.classNames.includes('fc-event-holiday'))
                .map(e => ({
                    title: e.title,
                    start: e.startStr,
                    allDay: e.allDay,
                    extendedProps: e.extendedProps || {},
                    className: e.classNames.join(' ')
                }));
            eventsRef.set(toSave);
        }

        function setStatus(txt, cls) {
            const s = document.getElementById('sync-status');
            if(s) { s.innerText = txt; s.className = "sync-indicator " + cls; }
        }

        function toggleToolbar() {
            const t = document.getElementById('toolbar');
            t.style.display = (t.style.display === "flex") ? "none" : "flex";
        }

        function changeZoom(v) {
            currentZoom = Math.min(Math.max(0.5, currentZoom + v), 1.0);
            document.getElementById('calendar').style.transform = `scale(${currentZoom})`;
            document.getElementById('calendar').style.transformOrigin = "top center";
            document.getElementById('zoom-val').innerText = Math.round(currentZoom * 100) + "%";
        }

        function clearFirebase() {
            if(confirm("Cancellare tutto dal cloud?")) eventsRef.set([]);
        }
    </script>
</body>
</html>
